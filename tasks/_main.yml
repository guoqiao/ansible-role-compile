---

- name: gather facts
  tags: always
  setup:


- name: define pkgs
  tags: always
  set_fact:
    _extra_pkgs: "{{ _util_pkgs[ansible_pkg_mgr] + extra_pkgs[ansible_pkg_mgr] }}"
    _builddep_pkgs: "{{ builddep_pkgs[ansible_pkg_mgr] }}"

- name: apt builddep
  become: yes
  when: 'ansible_pkg_mgr == "apt"'
  tags: apt
  block:

    - name: apt install
      apt:
        update_cache: yes
        cache_valid_time: 3600
        state: latest
        name: "{{ _extra_pkgs }}"
      register: task
      retries: 3
      delay: 1
      until: task is success

    - name: apt repository enable source pkgs
      apt_repository:
        repo: deb-src http://archive.ubuntu.com/ubuntu/ {{ ansible_lsb.codename }} main

    - name: apt-get build-dep
      apt:
        update_cache: yes
        cache_valid_time: 3600
        state: build-dep
        # apt.name support list, so no need to join
        name: "{{ _builddep_pkgs }}"
      register: task
      retries: 3
      delay: 1
      until: task is success


- name: yum builddep
  become: yes
  when: 'ansible_pkg_mgr == "yum"'
  tags: yum
  block:

    - name: remove yum.pid
      file:
        path: /var/run/yum.pid
        state: absent

    - name: yum install
      yum:
        update_cache: yes
        state: latest
        name: "{{ _extra_pkgs }}"
      register: task
      retries: 3
      delay: 1
      until: task is success

    - name: yum-builddep
      command: 'yum-builddep -y -q {{ _builddep_pkgs|join(" ") }}'


- name: dnf builddep
  become: yes
  when: 'ansible_pkg_mgr == "dnf"'
  tags: dnf
  block:

    - name: dnf install
      command: 'dnf install --assumeyes {{ _extra_pkgs|join(" ") }}'
      register: task
      retries: 3
      delay: 1
      until: task is success

    - name: dnf builddep
      command: 'dnf builddep --assumeyes {{ _builddep_pkgs|join(" ") }}'
      register: task
      retries: 3
      delay: 1
      until: task is success


- name: 'git clone -b {{ git_repo_version }} --depth {{ git_repo_depth }} {{ git_repo_url }} {{ git_repo_dest }}'
  tags: git-clone
  git:
    repo: "{{ git_repo_url }}"
    dest: "{{ git_repo_dest }}"
    version: "{{ git_repo_version }}"
    depth: "{{ git_repo_depth }}"


- name: 'run build commands in loop'
  become: yes
  command: "{{ item }}"
  args:
    chdir: "{{ git_repo_dest }}"
  loop:
      - "{{ command_distclean }}"
      - "{{ command_configure }}"
      - "{{ command_compile }}"
      - "{{ command_install }}"
      - "{{ command_link }}"
      - "{{ command_check }}"
